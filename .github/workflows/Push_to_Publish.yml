name: Push to Publish

on:
  workflow_dispatch:
  push:

jobs:
  push_to_publish:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo

      - name: Commit
        run: |
          cd $GITHUB_WORKSPACE
          rm -r $GITHUB_WORKSPACE/.github
          rm -r $GITHUB_WORKSPACE/.idea
          rm $GITHUB_WORKSPACE/db.sqlite3
          sed -i '/ALLOWED_HOSTS/d' $GITHUB_WORKSPACE/MeidaManageTool/settings.py
          sed -i '/EMAIL_USE_SSL/d' $GITHUB_WORKSPACE/MeidaManageTool/settings.py
          sed -i '/EMAIL_HOST/d' $GITHUB_WORKSPACE/MeidaManageTool/settings.py
          sed -i '/EMAIL_PORT/d' $GITHUB_WORKSPACE/MeidaManageTool/settings.py
          git remote remove origin
          git remote add origin https://github.com/AnthonyMSen/MMT.git
          git config --global user.email 1072519956@qq.com
          git config --global user.name Anthony_Actions
          git add .
          git commit -m "update" -a

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          repository: AnthonyMSen/MMT
          github_token: ${{ secrets.PUSH_TOKEN }}
          force: true

  sync_repo:
    needs: push_to_publish
    runs-on: ubuntu-latest
    steps:
      - name: Sync to GitHub
        uses: wearerequired/git-mirror-action@master
        env:
          SSH_PRIVATE_KEY: ${{ secrets.RSA_PRIVATE_KEY }}
        with:
          # 源仓库地址
          source-repo: "git@github.com:AnthonyMSen/MMT.git"
          # 目标仓库地址
          destination-repo: "git@gitee.com:AnthonyMSen/MMT.git"

  build_docker:
    needs: push_to_publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - id: repo_name
        uses: ASzc/change-string-case-action@v1
        with:
          string: ${{ github.repository_owner }}

      - name: 构建并推送到Dockerhub
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64,linux/ppc64le,linux/s390x
          push: true
          tags: |
            anthonymsen/mmt:latest